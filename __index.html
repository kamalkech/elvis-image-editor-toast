<html>
<head>
	<!-- <script language="JavaScript" src="${pluginsBaseRootUrl}/web.shared/jquery.min.js"></script>
	<script src="${pluginsBaseRootUrl}/web.shared/jquery.class.js" type="text/javascript"></script>
	<script src="${pluginsBaseRootUrl}/web.shared/elvis_api/js/jquery.elvis.js" type="text/javascript"></script>
	 -->

	<script src="${pluginsBaseRootUrl}/web.shared/jquery.js" type="text/javascript"></script>
	<script src="${pluginsBaseRootUrl}/web.shared/jquery.class.js" type="text/javascript"></script>
	<script src="${pluginsBaseRootUrl}/web.shared/jquery.cookie.js" type="text/javascript"></script>
	<link  href="${pluginsBaseRootUrl}/web.shared/elvis_api/css/elvis.css" rel="stylesheet" type="text/css"/>
	<script src="${pluginsBaseRootUrl}/web.shared/elvis_api/js/jquery.elvis.js" type="text/javascript"></script>


	<!-- Ressource -->
	<link  href="resources/jquery-ui-1.8.16.custom.css" rel="stylesheet" type="text/css"/>
	<script src="resources/jquery-ui-1.8.16.custom.min.js" type="text/javascript"></script>
	<script src="resources/jquery.iframe-transport.js" type="text/javascript"></script>
	<script src="resources/jquery.fileupload.js" type="text/javascript"></script>
	<link  href="resources/styles.css" rel="stylesheet" type="text/css"/>

	<!-- UI toast -->
	<link
		type="text/css"
		href="https://uicdn.toast.com/tui-color-picker/v2.2.3/tui-color-picker.css"
		rel="stylesheet">
	<link
		type="text/css"
		href="./tui.image-editor/dist/tui-image-editor.css"
		rel="stylesheet">
	<style>
	  @import url(http://fonts.googleapis.com/css?family=Noto+Sans);
	  html, body {
	    height: 100%;
	    margin: 0;
	  }
	  .tui-image-editor-container {
	  	height: 600px !important;
	  }
	</style>

	<!-- Custom Code Image Editor -->
	<script type="text/javascript">
		var elvisContext = ElvisPlugin.resolveElvisContext();
		var elvisApi = new ElvisAPI("${serverUrl}");
		var profile, refreshTimer, searchParams = null, currentContainerId = null;

		$(document).ready(function() {
			// Get asset data
			var urlAssetSelect = elvisContext.activeTab.assetSelection[0].originalUrl;
			var folderPath = elvisContext.activeTab.assetSelection[0].folderPath;
			$('form .folder-path').val(folderPath);


			// Image editor
			var nameFile = 'SampleImage';

	    var imageEditor = new tui.ImageEditor('#tui-image-editor-container', {
	      includeUI: {
	        loadImage: {
	          path: urlAssetSelect,
	          name: nameFile
	        },
	        theme: blackTheme, // or whiteTheme
	        initMenu: 'filter',
	        menuBarPosition: 'bottom'
	      },
	      cssMaxWidth: 700,
	      cssMaxHeight: 200,
	      usageStatistics: false
	    });

	    // 
	    window.onresize = function() {
	      imageEditor.ui.resizeEditor();
	    }

	    // 
	    $('.download-asset').click( function() {
	    	// imageEditor.getActions().main.load(urlAssetSelect);
	    	// imageEditor.getActions().main.download();
	    	// console.log(imageEditor.toDataURL());
	    	
	    	var dataURL = imageEditor.toDataURL()
	    	var imageName = imageEditor.getImageName();

	    	// Split the base64 string in data and contentType
				var block = dataURL.split(";");
				// Get the content type of the image
				var contentType = block[0].split(":")[1];// In this case "image/gif"
				// get the real base64 content of the file
				var realData = block[1].split(",")[1];

				var blob = b64toBlob(realData, contentType);

				//var blob2 = new Blob(realData, { type: contentType });
				var file = new File([blob], 'mm-' + imageName, {type: contentType, lastModified: Date.now()});
				console.log('file', file);

    		console.log('contentType', contentType);
    		console.log('realData', realData);

    		// Create a FormData and append the file with "image" as parameter name
    		var form = document.getElementById("myAwesomeForm");
				var formDataToUpload = new FormData(form);
				formDataToUpload.append("image", blob);

				$.ajax({
			    url: '${serverUrl}/services/create',
			    data: formDataToUpload,// Add as Data the Previously create formData
			    type: "POST",
			    contentType: false,
			    processData: false,
			    cache: false,
			    dataType:" json", // Change this according to your response from the server.
			    error: function(err) {
			      console.error(err);
			    },
			    success: function(data) {
			      console.log(data);
			    },
			    complete: function(){
			      console.log("Request finished.");
			    }
				});

	    	// Custom copy file
	   		// var fileMetaData = elvisContext.activeTab.assetSelection[0].metadata;

				// var params = {
				// 	source: formData,
				// 	target: folderPath + '/MM-' + fileMetaData.filename
				// };
				// elvisApi.copy(params, function() {refreshResultsPostponed()});
	    });

	    /**
			 * Convert a base64 string in a Blob according to the data and contentType.
			 * 
			 * @param b64Data {String} Pure base64 string without contentType
			 * @param contentType {String} the content type of the file i.e (image/jpeg - image/png - text/plain)
			 * @param sliceSize {Int} SliceSize to process the byteCharacters
			 * @see http://stackoverflow.com/questions/16245767/creating-a-blob-from-a-base64-string-in-javascript
			 * @return Blob
			 */
			function b64toBlob(b64Data, contentType, sliceSize) {
        contentType = contentType || '';
        sliceSize = sliceSize || 512;

        var byteCharacters = atob(b64Data);
        var byteArrays = [];

        for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            var slice = byteCharacters.slice(offset, offset + sliceSize);

            var byteNumbers = new Array(slice.length);
            for (var i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }

            var byteArray = new Uint8Array(byteNumbers);

            byteArrays.push(byteArray);
        }
	      var blob = new Blob(byteArrays, {type: contentType});
	      return blob;
			}

			// 
	    function refreshResults(start, num) {
				// init defaults for optional parameters
				if (start == null) {
					start = 0;
				}
				if (num == null) {
					num = 50;
				}

				// build query
				var query = $('#querystring').val();
				//query += " +(assetDomain:image OR assetDomain:video OR textContent:*)";

				if (columnTree.containerId) {
					query = "relatedTo:" + columnTree.containerId + " relationTarget:child relationType:contains " + query;
				}
				else if (columnTree.folderPath) {
					query += ' ancestorPaths:"' + columnTree.folderPath + '"';
				}

				var params = {
					q: query,
					start: start,
					num: num,
					sort: "name",
					metadataToReturn: hitRenderer.metadataToDisplay.join(","),
					facets: facetRenderer.facets.join(",")
				};

				// add facet selections
				facetRenderer.addFacetSelectionParams(params);

				// execute search and update results
				elvisApi.search(params, function(data) {

					hitRenderer.render(data);

					facetRenderer.render(data);

				});
			}

			// 
	    function refreshResultsPostponed() {
				window.clearTimeout(refreshTimer);
				refreshTimer = window.setTimeout(function() {
					//refreshResults() ;
				}, 200);
			}
		});
	</script>

	<!-- Upload File -->
	<script type="text/javascript">
		$(function () {
		  
		  //fileupload
		  var count = {
		    success: 0,
	      failed: 0,
	      fnames: []
		  }
		  var infoTimer, dropTimer, csrfToken;
		  // var elvisApi = new ElvisAPI("${serverUrl}");
		  elvisApi.useAutoLogin("guest", "guest", "api_sample_DAMtube");

		  $("#fileupload-form").bind("submit", function(){ return false; });
		  $("input.submit").bind("click", function(){
	      $("div.file-list-box div.item").each(function(){
	      	// console.log('$(this)', $(this).data("data"));
          var data = $(this).data("data");
          data.jqXHR = data.submit();
          if (data && data.submit && !data.jqXHR) {
            data.jqXHR = data.submit();
            $(this).removeData("data");
          } else {
            $(this).fadeOut(function(){
              $(this).remove();
            });
          }
	      });
		  });
		  $("#fileupload").fileupload({
	      dataType: "json",
	      add: function (e, data) {
          $("div.upload-info-box").hide();
          count.success = 0;
          count.failed = 0;
          count.fnames = [];
          window.clearTimeout(infoTimer);
          
          var filename = [];
          $.each(data.files, function(index, file){
            filename[filename.length] = file.name ;
          });
          var box = $("<div/>").addClass("progress-text-box").addClass("item").append($("<span/>").addClass("text").text(filename.join(", ")));
          $("div.file-list-box").append(box);
          data.context = box;
          data.context.progressbar({value: 0});
          box.data("data", data);
          if (!csrfToken) {
            elvisApi.csrf(function(data, textStatus, jqXHR) {
              csrfToken = data.csrfToken;
            });
          }
	      },
	      send: function (e, data) {
          if (data.context.is("div.progress-text-box"))
            data.context.progressbar({value: 0});
	      },
	      progress: function (e, data) {
          var progress = parseInt(data.loaded / data.total * 100, 10);
          if (data.context.is("div.progress-text-box"))
            data.context.progressbar({value: progress});
	      },
	      progressall: function (e, data) {
	          //
	      },
	      done: function (e, data) {
          if (data.result && ! data.result.errorcode) {
            count.success++;
            if (data.context.is("div.progress-text-box")) {
              data.context.fadeOut(function(){
                $(this).remove();
              });
            }
          } else {
	          count.failed++;
	          $.each(data.files, function(index, file){
	            count.fnames[count.fnames.length] = file.name;
	          });
	          if (data.context.is("div.progress-text-box")) {
              data.context.addClass("progress-text-message-box")
              .find("span.text")
              .text(data.result.message ? data.result.message : "Error");
	          }
          }
	      },
	      fail: function (e, data) {
          count.failed++;
          $.each(data.files, function(index, file){
            count.fnames[count.fnames.length] = file.name;
          });
          if (data.context.is("div.progress-text-box")) {
            data.context.addClass("progress-text-message-box").find("span.text").text("Error");
          }
	      },
	      stop: function (e, data) {
          var m = "Uploaded: " + count.success + " file(s).";
          if (count.failed > 0)
            m += " Error files upload: " + count.failed + " (" + count.fnames.join(", ") + ")";
          else
            infoTimer = setTimeout(function(){$("div.upload-info-box").fadeOut();}, 30000);
          setTimeout(function(){
            $("div.upload-info-box").html(m).fadeIn();
          }, 800);
	      },
	      dragover: function(e) {
	        window.clearTimeout(dropTimer);
          $("#dropIndicator").addClass("dropMarker");
          dropTimer = window.setTimeout(function(){$("#dropIndicator").removeClass("dropMarker");}, 2000);
	      },
	      drop: function() {
          window.clearTimeout(dropTimer);
          $("#dropIndicator").removeClass("dropMarker");
	      },
	      beforeSend: function(xhr) {
	        xhr.setRequestHeader("X-CSRF-TOKEN", csrfToken);
	      }
		  });
		  console.log('upload 1');
		  
		});
	</script>

	<script type="text/javascript">
		
		$(function() {

			$(document).ready(function() { 
        $("#but_upload").click(function(e) {
        	e.preventDefault();

        	//fileupload
				  var count = {
				    success: 0,
			      failed: 0,
			      fnames: []
				  }
				  var infoTimer, dropTimer, csrfToken;
				  // var elvisApi = new ElvisAPI("${serverUrl}");
				  elvisApi.useAutoLogin("guest", "guest", "api_sample_DAMtube");

          var fd = new FormData(); 
          var files = $('#file')[0].files[0]; 
          fd.append('file', files); 

          console.log('csrfToken 1', csrfToken);

          if (!csrfToken) {
            elvisApi.csrf(function(data, textStatus, jqXHR) {
              csrfToken = fd.csrfToken;
              console.log('csrfToken 2', csrfToken);
            });
          }
 
          $.ajax({ 
            url: '${serverUrl}/services/create', 
            type: 'post', 
            data: fd, 
            contentType: false, 
            processData: false, 
            success: function(response){ 
              if (response != 0) { 
                alert('file uploaded'); 
              } 
              else{ 
                alert('file not uploaded'); 
              } 
            },
            beforeSend: function(xhr) {
            	console.log('csrfToken', csrfToken);
		          xhr.setRequestHeader("X-CSRF-TOKEN", csrfToken);
		        }
          }); 
        }); 
      }); 

		})
	</script>

</head>
<body>

    
    
	<!-- <div align="center"> 
        <form method="post" action="" enctype="multipart/form-data"
                id="${serverUrl}/services/create"> 
   
            <div > 
            	<input type="hidden" class="folder-path" name="folderPath" value="/DAMtube" />
                <input type="file" id="file" name="file" /> 
                <input type="button" class="button" value="Upload"
                        id="but_upload"> 
            </div> 
        </form> 
    </div> 
 -->
  <form action="${serverUrl}/services/create" method="post" enctype="multipart/form-data">
	<!-- <input type="hidden" name="nextUrl" value="...mypage.html#${id}"> -->
		<input type="hidden" name="folderPath" value="/DAMtube">
		<label for="file">File </label>
		<input type="file" name="Filedata" id="file">
		<br><br>
		<input type="submit" value="Create" id="but_upload">
	</form>

	<div class="custom-download" style="display: none;">
		<button class="download-asset">Download</button>
		<form id="myAwesomeForm" method="post" action="/php-code-that-handles-fileupload.php">
	    <input type="text" id="filename" name="filename" /> <!-- Filename -->
	    <input type="submit" id="submitButton" name="submitButton" /> <!-- Submit -->
		</form>
	</div>

	<hr>

	<div id="wrapper" style="display: none;">

		<div id="header">
				<a href="index.html"><img class="logo" src="resources/logo.png" alt="DAMtube"/></a>
		</div>

		<div id="pages">

			<div id="upload">
				<form action="${serverUrl}/services/create" method="post" enctype="multipart/form-data" id="fileupload-form">
					<input type="hidden" class="folder-path" name="folderPath" value="/DAMtube" />
					
					<div class="uploadbox uploadbox-multi">
						<div id="dropIndicator">
							<h2>Drop or select files to upload</h2>
							<input id="fileupload" type="file" name="Filedata" multiple="multiple"/>
							<div class="file-list-box"></div>
							<div class="upload-info-box"></div>
						</div>
					</div>

					<div class="meta">
						<h2>Additional information</h2>
						<table>
							<tr>
								<td><label for="title">Title</label></td>
								<td><input name="title" type="text" placeholder="Title" /></td>
							</tr>
							<tr>
								<td><label for="description">Description</label></td>
								<td><textarea name="description" rows="4" cols="8" placeholder="Description"></textarea></td>
							</tr>
							<tr>
								<td><label for="tags">Tags</label></td>
								<td><input name="tags" type="text" placeholder="Tags" /></td>
							</tr>
						</table>
						<div class="submit">
							<input id="upload" type="submit" value="Upload" class="submit"/>
						</div>
					</div>
				</form>
			</div>

		</div>
	</div>

	<hr>

	<div id="tui-image-editor-container"></div>

  <script
    type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.3.2/fabric.js"></script>
  <script
    type="text/javascript"
    src="https://uicdn.toast.com/tui.code-snippet/v1.5.0/tui-code-snippet.min.js"></script>
  <script
    type="text/javascript"
    src="https://uicdn.toast.com/tui-color-picker/v2.2.3/tui-color-picker.js"></script>
  <script
    type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
  <script
    type="text/javascript"
    src="./tui.image-editor/dist/tui-image-editor.js"></script>
  <script
    type="text/javascript"
    src="./tui.image-editor/examples/js/theme/white-theme.js"></script>
  <script
    type="text/javascript"
    src="./tui.image-editor/examples/js/theme/black-theme.js"></script>
</body>
</html>
